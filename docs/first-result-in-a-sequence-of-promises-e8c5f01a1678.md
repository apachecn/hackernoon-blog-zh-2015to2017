# ä¸€ç³»åˆ—æ‰¿è¯ºä¸­çš„ç¬¬ä¸€ä¸ªç»“æœ

> åŸæ–‡ï¼š<https://medium.com/hackernoon/first-result-in-a-sequence-of-promises-e8c5f01a1678>

æœ€è¿‘ï¼Œæˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºä¸­å®ç°äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œäº§ç”Ÿäº†ä¸€ä¸ªå¾ˆå¥½çš„ç±»ä¼¼ kata çš„ä»»åŠ¡ï¼Œé¼“åŠ±æˆ‘ç© JavaScript æ‰¿è¯ºï¼Œå¹¶åŠ æ·±æˆ‘å¯¹å®ƒä»¬çš„äº†è§£ã€‚

![](img/46990338846f76354fd0734d69212b20.png)

Illustration of [Autocomplete](https://dribbble.com/shots/2220256-Autocomplete) by [Martin Bonov](https://medium.com/u/97ed1df6cbc8?source=post_page-----e8c5f01a1678--------------------------------)

**ä»»åŠ¡:**

*å¯¹äºè‡ªåŠ¨å®Œæˆï¼Œæœ‰å‡ ä¸ªæœåŠ¡å¯ä»¥è¯¢é—®ç”¨æˆ·è¾“å…¥çš„å»ºè®®ã€‚è¿™äº›æœåŠ¡æ˜¯ä»æˆ‘ä»¬è‡ªå·±çš„æœåŠ¡å™¨(ä¾¿å®œ)ï¼Œåˆä½œä¼™ä¼´çš„ï¼Œè°·æ­Œçš„(æ˜‚è´µ)è®¢è´­çš„ã€‚æˆ‘ä»¬å¸Œæœ›å‘ç”¨æˆ·æ˜¾ç¤ºç¬¬ä¸€ä¸ªéç©ºå“åº”ã€‚æ­¤å¤–ï¼Œåªæœ‰åœ¨å‰ä¸€ä¸ªæœåŠ¡æ²¡æœ‰å»ºè®®ä»»ä½•é¡¹ç›®çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ‰å¸Œæœ›è¯¢é—®ä¸‹ä¸€ä¸ªæœåŠ¡ã€‚*

å“¦ï¼Œè¿˜æœ‰ä¸€ç‚¹å’Œå½¢å¾ˆç›¸ä¼¼ï¼Œé‚£å°±æ˜¯æˆ‘åœ¨è§£å†³å®ƒçš„æ—¶å€™å¾ˆå¼€å¿ƒã€‚

# å½¢å½¢å¼çš„é—®é¢˜

ç”¨æŠ€æœ¯æœ¯è¯­æ¥è¯´ï¼Œ*æœåŠ¡*æ˜¯ä¸€ä¸ªè¿”å›æ‰¿è¯ºçš„å¼‚æ­¥å‡½æ•°ã€‚è¿™ä¸ªæ‰¿è¯ºï¼Œåœ¨è§£å†³æ—¶ï¼ŒåŒ…å«äº†ä¸€ç³»åˆ—çš„å»ºè®®ã€‚è¯¥æ•°ç»„å¯ä»¥ä¸ºç©ºã€‚è¯·æ³¨æ„ï¼Œç©ºç»“æœä¸åŒäºæ‹’ç»æ‰¿è¯ºã€‚

ç»™å®šè¿™äº›*æœåŠ¡çš„åˆ—è¡¨*è°ƒç”¨æ¯ä¸ª*æœåŠ¡*ï¼Œç­‰å¾…å…¶ç»“æœï¼Œç„¶åæˆ–è€…è¿”å›ç»“æœ(å¦‚æœéç©º)æˆ–è€…ç»§ç»­ä¸‹ä¸€ä¸ª*æœåŠ¡*ã€‚

> ç°åœ¨ï¼Œåœ¨æˆ‘å±•ç¤ºæˆ‘çš„è§£å†³æ–¹æ¡ˆä¹‹å‰ï¼Œæ˜¯æ—¶å€™äº²è‡ªå°è¯•ä¸€ä¸‹äº†â€”â€”å¦‚æœæ‚¨æ„¿æ„çš„è¯ã€‚ä»åŸºæœ¬æµ‹è¯•ç”¨ä¾‹çš„[æ ·æ¿æ–‡ä»¶å¼€å§‹:](https://gist.github.com/robinpokorny/fb01d868d79e9afadff5d5ddcfa48f08)

# ç°æœ‰åº“å’Œè§£å†³æ–¹æ¡ˆ

åœ¨æˆ‘å¯¹ç°æœ‰è§£å†³æ–¹æ¡ˆçš„ç ”ç©¶ä¸­ï¼Œä¸€ä¸ªå°éšœç¢æ˜¯æˆ‘ä¸çŸ¥é“å¦‚ä½•ç”¨å…³é”®è¯æ¥æè¿°å®ƒã€‚æœ€åï¼Œæˆ‘å°è¯•äº†â€œç¬¬ä¸€â€ã€â€œé¡ºåºâ€ã€â€œçº§è”â€ã€â€œç€‘å¸ƒâ€å’Œâ€œå›é€€â€ä»¥åŠæ˜æ˜¾çš„â€œæ‰¿è¯ºâ€ã€‚ç„¶åæˆ‘å¿…é¡»è¿‡æ»¤æ‰å¤§é‡æè¿°`Promise.all`æˆ–`Promise.race`çš„ç»“æœã€‚

## [æ‰¿è¯º-å›é€€](https://www.npmjs.com/package/promise-fallback)

ç»è¿‡ä¸€äº›ç ”ç©¶ï¼Œæˆ‘å‘ç°è¿™ä¸ª NPM åŒ…åŸºæœ¬ä¸Šè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å®ƒä½¿ç”¨äº†ä¸€ç§(ç›¸å½“éº»çƒ¦çš„)é€’å½’ï¼Œæ€»ä½“æ¥è¯´æ—¢ä¸å®¹æ˜“ç†è§£ä¹Ÿä¸ä¼˜é›…ã€‚å‚è§ GitHub ä¸Šçš„[ä»£ç ](https://github.com/CharlesWall/promise-fallback/blob/6095a5deff9dbbe60006d50d1d2ccda82e8187c4/src/index.coffee)(åœ¨ CoffeeScript ä¸­)ã€‚ä¸è¿‡ï¼Œ*æ¯”ç…§*å®ƒå¯ä»¥ä¸ºæˆ‘ä»¬æ‰€ç”¨ã€‚

## [æŒ‰é¡ºåºæ‰§è¡Œæ‰¿è¯º](https://www.abeautifulsite.net/executing-promises-in-sequence-and-stopping-at-the-first-resolved-promise)

Cory LaViska åœ¨æœ€è¿‘çš„ä¸€ç¯‡æ–‡ç« ä¸­è§£é‡Šäº†ç±»ä¼¼ä»»åŠ¡çš„ç¬¬äºŒç§æ–¹æ³•(æ–‡ä»¶ååˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªç°æœ‰æ–‡ä»¶)ã€‚å®ƒè¿˜åˆ©ç”¨äº†é€’å½’ã€‚è™½ç„¶æ„Ÿè§‰æ›´æ•´æ´(æ²¡æœ‰ CoffeeScript å¸®åŠ©ğŸ˜œ)ï¼Œæˆ‘ä¸èƒ½è¯´å®ƒè¯»èµ·æ¥å¾ˆå¥½ã€‚ä½œè€…è‡ªå·±ä»¥ä¸€ä¸ªé—®é¢˜â€œä½ æœ‰æ›´ä¼˜é›…çš„æ–¹æ³•å—ï¼Ÿâ€

# æˆ‘çš„è§£å†³æ–¹æ¡ˆ

å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘è¿˜æ˜¯å¸Œæœ›æœ‰ä¸€ä¸ªå°çš„ã€å¯è¯»çš„ã€å¯ç»´æŠ¤çš„æ–¹æ³•ã€‚æˆ‘çš„ç†æƒ³è§£å†³æ–¹æ¡ˆç±»ä¼¼äº [koa](http://koajs.com/) ä¸­é—´ä»¶ã€‚

## è¿­ä»£ 1: Promise.reduceã€Koa å’Œ wrappers

æœ€åï¼ŒCory çš„æ–‡ç« è¢«è¯æ˜æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå› ä¸ºå®ƒç»™æˆ‘æŒ‡å‡ºäº†æˆ‘å‘ç° [Promise.reduce](http://bluebirdjs.com/docs/api/promise.reduce.html) çš„è“é¸Ÿæ–‡æ¡£ã€‚

![](img/9b27baf5275541a7d8a977d4c6705f87.png)

Middleware architecture on a [slide](http://www.slideshare.net/joncrosby/rack-middleware/89-Middleware_App_HTTPTuesday_March_17) by [Jon Crosby](https://medium.com/u/d903c92bf073?source=post_page-----e8c5f01a1678--------------------------------)

è™½ç„¶`Promise.reduce`æœ‰ä¸åŒçš„ç”¨é€”â€”â€”ä¾‹å¦‚ï¼Œå°†å¤šä¸ªæ–‡ä»¶çš„å†…å®¹ç›¸åŠ â€”â€”ä½†å®ƒæ‰§è¡Œä¸€ä»¶é‡è¦çš„äº‹æƒ…ã€‚å½“éå†æ•°ç»„æ—¶ï¼Œåœ¨ç»§ç»­ä¸‹ä¸€æ¬¡è¿­ä»£ä¹‹å‰ï¼Œç­‰å¾…æ‰¿è¯ºçš„ç»“æœã€‚

æˆ‘æƒ³åˆ›å»ºä¸€ä¸ªæ‰¿è¯ºé“¾ï¼Œè€Œä¸æ˜¯é€’å½’è°ƒç”¨ fallback å‡½æ•°ã€‚å› æ­¤ï¼Œæˆ‘å°†æ¯ä¸ª*æœåŠ¡*åŒ…è£…åœ¨ä¸€ä¸ªåŒ…è£…å‡½æ•°ä¸­ï¼Œè¯¥åŒ…è£…å‡½æ•°æ¥æ”¶åˆ°ç›®å‰ä¸ºæ­¢çš„æœ€æ–°ç»“æœ*ã€‚ç„¶åï¼Œå¦‚æœè¿™ä¸ªç»“æœæ˜¯ç©ºçš„ï¼Œå®ƒè°ƒç”¨æœåŠ¡å¹¶è¿”å›å®ƒæ”¶åˆ°çš„æ‰¿è¯ºã€‚å¦ä¸€æ–¹é¢ï¼Œå®ƒåªæ˜¯ä¼ é€’ç»“æœâ€”â€”å°±å¥½åƒè·¯å¾„åœ¨ koa ä¸­é—´ä»¶ä¸­ä¸åŒ¹é…ä¸€æ ·ã€‚*

*çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„:*

```
*const myServiceWrapper = (latestResult) =>
  !latestResult.length
    ? myService(userInput)
    : latestResultconst partnerServiceWrapper = â€¦
const googleServiceWrapper = â€¦*
```

*è¿™æ ·çš„åŒ…è£…å™¨å¾ˆå®¹æ˜“è¢«é“¾æ¥èµ·æ¥:*

```
*Promise.resolve([])
  .then(myServiceWrapper)
  .then(partnerServiceWrapper)
  .then(googleServiceWrapper)*
```

*è¿™é‡Œ`Promise.resolve([])`ä½œä¸ºæ‰¿è¯ºé“¾çš„*å¯åŠ¨å™¨*ã€‚å¤šäºäº†å®ƒï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³ä½¿ç”¨`then`ã€‚æ­¤å¤–ï¼Œå®ƒå°†ç¬¬ä¸€ä¸ªåŒ…è£…å™¨çš„`latestResult`è®¾ç½®ä¸º`[]`ã€‚*

*æ‰¾åˆ°äº†ã€‚è¿™ä¸ª*å·®ç‚¹*è§£å†³äº†æˆ‘ä»¬çš„é—®é¢˜ï¼*

## *è¿­ä»£ 2:å‡å°‘åˆ°äº”è¡Œ*

*è¿™äº›åŒ…è£…å™¨ç®€å•ã€æ˜“è¯»ä¸”ç‹¬ç«‹ã€‚è¿™æ„å‘³ç€å¯ç»´æŠ¤æ€§ã€‚*

*é‚£ä¹ˆæ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿé¦–å…ˆï¼Œæˆ‘ä»¬ä¸æƒ³å†™æ ·æ¿æ–‡ä»¶ã€‚å…¶æ¬¡ï¼Œ*æœåŠ¡*çš„æ•°é‡æœªçŸ¥ã€‚æˆ‘ä»¬æƒ³ä¼ é€’ç»™æˆ‘ä»¬çš„å‡½æ•°ä¸€ä¸ªç»™å®šçš„*æœåŠ¡æ•°ç»„*ã€‚*

*å·§åˆçš„æ˜¯ï¼Œæˆ‘ä»¬ä¸€æ­¥è§£å†³äº†è¿™ä¸¤ä¸ªé—®é¢˜ã€‚è¿™é‡Œä¸€ä¸ªé‡è¦çš„æç¤ºæ˜¯å‰é¢æåˆ°çš„`Promise.reduce`çš„åå­—ã€‚*

*é‚£äº”ä¸ª(ï¼)line è§£å†³æ–¹æ¡ˆä½¿ç”¨`Array.reduce`å¯¹ä»»æ„æ•°é‡çš„æœåŠ¡æ‰§è¡Œä¸ä¸Šé¢çš„åŒ…è£…å™¨é“¾å®Œå…¨ç›¸åŒçš„æ“ä½œ(å“¦ï¼ğŸ˜ƒ).*

*æˆ‘ä»¬ä»`Promise.resolve([])`å¼€å§‹è¿™ä¸ªé“¾ï¼Œç„¶ååœ¨æ¯æ¬¡è¿­ä»£ä¸­`prev`æ˜¯ä¸€ä¸ªæ‰¿è¯ºï¼Œ`next`æ˜¯ä¸€ä¸ª*æœåŠ¡*ã€‚*

```
*const firstResult = (services, userInput) => services.reduce(
  (prev, next) => prev.then((result) =>
    !result.length ? next(userInput) : result
  ),
  Promise.resolve([])
)*
```

# *å¹¿ä¹‰è§£*

*åæ¥ï¼Œæˆ‘æ¦‚æ‹¬äº†æ‰¿è¯ºåºåˆ—ä¸­ç¬¬ä¸€ä¸ªéç©ºç»“æœçš„ä»£ç ã€‚S *æœåŠ¡*ç°åœ¨æ˜¯æ¨¡ç³Šçš„*ä»»åŠ¡*ã€‚*

> *ä½ å–œæ¬¢[æµ](https://flowtype.org/)å—ï¼Ÿè¯·çœ‹ä¸‹é¢å¸¦ç±»å‹æ ‡æ³¨çš„è§£å†³æ–¹æ¡ˆï¼*

*ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼Œæ‚¨å¯ä»¥ä¼ é€’ä¸€äº›é€‰é¡¹(å¸¦æœ‰é»˜è®¤å€¼):*

*   *`args=[]`:ä¼ é€’ç»™æ¯ä¸ª*ä»»åŠ¡çš„å‚æ•°**
*   *`initial=undefined`:ç»™*ä¸€ä¸ªå€¼å¼€å§‹*æ‰¿è¯ºé“¾*
*   *`isEmpty=(x) => !x`:åˆ¤æ–­ç»“æœæ˜¯å¦ä¸ºç©ºçš„å‡½æ•°ã€‚åº”è¯¥å¾ˆå¿«ï¼Œå› ä¸ºå®ƒæ˜¯é‡å¤è¿è¡Œçš„ã€‚*

*General solution with options*

# *è¯„è®º*

*   *å› ä¸ºä»£ç å®é™…ä¸Šåªæœ‰ 5 è¡Œï¼Œæ‰€ä»¥æˆ‘å†³å®šä¸æŠŠå®ƒä½œä¸ºç‹¬ç«‹çš„ NPM åŒ…å‘å¸ƒã€‚æˆ–è€…æˆ‘åº”è¯¥ï¼Ÿ*
*   *å¦‚ä¸Šæ‰€è¿°ï¼Œ`isEmpty`å‡½æ•°è¢«è°ƒç”¨çš„æ¬¡æ•°æ€»æ˜¯ä¸ä»»åŠ¡æ•°ç›¸åŒã€‚è¿™æ˜¯å­¤ç«‹çš„ä¸€ä¸ªç¼ºç‚¹ã€‚*
*   *åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`!result.length`ä¸æ˜¯ä¸€ä¸ªå¥½çš„çœŸå®æ¡ä»¶ï¼Œå› ä¸ºå¦‚æœ`result`æœªå®šä¹‰ï¼Œå®ƒå°†æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚*
*   *å½“ä»»ä½•*ä»»åŠ¡*è¢«æ‹’ç»æ—¶ï¼Œæ•´ä¸ªå°è£…æ‰¿è¯ºä¹Ÿè¢«æ‹’ç»ã€‚*

# *é¢å¤–æ”¶è·:å¸¦æœ‰æµç±»å‹æ³¨é‡Šçš„è§£å†³æ–¹æ¡ˆ*

*ä¸ºäº†æ¸…æ¥šèµ·è§ï¼Œæˆ‘ç”¨*æµ*ç±»å‹çš„æ³¨é‡Šç»™å‡ºäº†ä¸Šé¢çš„è§£å†³æ–¹æ¡ˆï¼Œè¿™ä½¿å¾—æ•´ä¸ªä»£ç æœ‰ç‚¹é•¿ï¼›è™½ç„¶ï¼Œä¸»è¦éƒ¨åˆ†è¿˜æ˜¯äº”è¡Œå·¦å³ã€‚*

*æ³¨æ„ï¼Œé€šç”¨ç±»å‹`T`å¯¹åº”äº*ä»»åŠ¡*çš„ç»“æœï¼Œå› æ­¤ä¹Ÿå¯¹åº”äºæ•´ä½“ç»“æœã€‚*

*Solution with (rather verbose) type annotations*

*ç¬¦å·`?T`è¡¨ç¤ºç±»å‹*å¯ç©º*ï¼Œå‚è§[è§£é‡Š](https://gist.github.com/robinpokorny/b18ecd4565104831a78b02a43d62c1af)ã€‚*

> ***è¯·å¸®å¿™:**ä½ è§‰å¾—æµç¨‹æ ‡æ³¨æœ‰å¸®åŠ©å—ï¼Ÿå®ƒä¸ºä½ å¢å€¼äº†å—ï¼Ÿæˆ‘åº”è¯¥ç»§ç»­æ·»åŠ å®ƒä»¬å—ï¼Ÿ*

**å¦‚æœä½ å–œæ¬¢è¿™ä¸ªå¸–å­ï¼Œè¯·åˆ«å¿˜äº†ç»™ä¸ª*ğŸ‘*ä¸‹å›¾*ã€‚æ¯ä¸€ä¸ªé¼“æŒé€šçŸ¥å¯¹æˆ‘æ¥è¯´éƒ½æ˜¯ä¸€ç§æ¿€åŠ±ã€‚*

*å¦‚æœä½ æƒ³äº†è§£æ›´å¤šï¼Œæˆ‘æœ€è¿‘åœ¨ YouTube ä¸Šå¼€äº†ä¸€ä¸ªå…³äº JavaScript çš„é¢‘é“ã€‚æˆ‘æ¯å‘¨éƒ½ä¼šå‘å¸ƒæ–°è§†é¢‘ï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘è®¢é˜…ã€‚ä»ä¸€å¼€å§‹å°±åœ¨é‚£é‡Œï¼Œå¸®åŠ©æˆ‘å˜å¾—æ›´å¥½ã€‚*

*[](https://www.youtube.com/c/robinpokorny?sub_confirmation=1) [## YouTube ä¸Šçš„ç½—å®¾Â·æ³¢ç§‘å°”å°¼

### JavaScript æ˜¯æˆ‘çš„æ¿€æƒ…æ‰€åœ¨:æˆ‘å–œæ¬¢å†™ JavaScriptï¼Œæˆ‘å–œæ¬¢è¯» JavaScriptï¼Œæˆ‘å–œæ¬¢è¯´ JavaScriptã€‚

www.youtube.com/c/robinpokorny](https://www.youtube.com/c/robinpokorny?sub_confirmation=1)* 

## *ç›¸å…³æ–‡ç« *

*   *[æŒ‰é¡ºåºæ‰§è¡Œæ‰¿è¯º(å¹¶åœ¨ç¬¬ä¸€ä¸ªè§£å†³çš„æ‰¿è¯ºå¤„åœæ­¢)](https://www.abeautifulsite.net/executing-promises-in-sequence-and-stopping-at-the-first-resolved-promise)ç”±[ç§‘é‡ŒÂ·æ‹‰ç»´æ–¯å¡](https://medium.com/u/1e2dfa2c83d2?source=post_page-----e8c5f01a1678--------------------------------)*
*   *è“é¸Ÿæ–‡æ¡£ä¸­çš„[æ‰¿è¯º.å‡å°‘](http://bluebirdjs.com/docs/api/promise.reduce.html)*

*[![](img/50ef4044ecd4e250b5d50f368b775d38.png)](http://bit.ly/HackernoonFB)**[![](img/979d9a46439d5aebbdcdca574e21dc81.png)](https://goo.gl/k7XYbx)**[![](img/2930ba6bd2c12218fdbbf7e02c8746ff.png)](https://goo.gl/4ofytp)*

> *[é»‘å®¢ä¸­åˆ](http://bit.ly/Hackernoon)æ˜¯é»‘å®¢å¦‚ä½•å¼€å§‹ä»–ä»¬çš„ä¸‹åˆã€‚æˆ‘ä»¬æ˜¯ [@AMI](http://bit.ly/atAMIatAMI) å®¶åº­çš„ä¸€å‘˜ã€‚æˆ‘ä»¬ç°åœ¨[æ¥å—æŠ•ç¨¿](http://bit.ly/hackernoonsubmission)å¹¶ä¹æ„[è®¨è®ºå¹¿å‘Š&èµåŠ©](mailto:partners@amipublications.com)æœºä¼šã€‚*
> 
> *å¦‚æœä½ å–œæ¬¢è¿™ä¸ªæ•…äº‹ï¼Œæˆ‘ä»¬æ¨èä½ é˜…è¯»æˆ‘ä»¬çš„[æœ€æ–°ç§‘æŠ€æ•…äº‹](http://bit.ly/hackernoonlatestt)å’Œ[è¶‹åŠ¿ç§‘æŠ€æ•…äº‹](https://hackernoon.com/trending)ã€‚ç›´åˆ°ä¸‹ä¸€æ¬¡ï¼Œä¸è¦æŠŠä¸–ç•Œçš„ç°å®æƒ³å½“ç„¶ï¼*

*![](img/be0ca55ba73a573dce11effb2ee80d56.png)*