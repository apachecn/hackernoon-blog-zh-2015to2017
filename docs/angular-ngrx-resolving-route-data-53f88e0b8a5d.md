# è§’åº¦ NgRx:è§£æžè·¯å¾„æ•°æ®

> åŽŸæ–‡ï¼š<https://medium.com/hackernoon/angular-ngrx-resolving-route-data-53f88e0b8a5d>

![](img/1206642b7253a18f3aef3bcdf13fa212.png)

åœ¨è¿™äº› **Angular NgRX** æ•…äº‹ç³»åˆ—ä¸­ï¼Œæˆ‘å°†ä»‹ç» Angular åº”ç”¨ç¨‹åºçš„ä¸€äº›å…·ä½“éƒ¨åˆ†ï¼Œè¿™äº›éƒ¨åˆ†ç”¨ NgRX åº“å®žçŽ°èµ·æ¥å¹¶ä¸æ˜Žæ˜¾ã€‚

[NgRx](https://github.com/ngrx) æ˜¯å— [Redux](https://hackernoon.com/tagged/redux) å¯å‘ï¼Œé’ˆå¯¹è§’åº¦åº”ç”¨çš„ [RxJS](http://reactivex.io/rxjs/) ä¾›ç”µçŠ¶æ€[ç®¡ç†](https://hackernoon.com/tagged/management)ã€‚å®ƒå¸®åŠ©æˆ‘ä»¬ç®¡ç†åº”ç”¨ç¨‹åºçš„çŠ¶æ€ï¼Œå¹¶ä¸”æ¯”æ ‡å‡†çš„é¢å‘æœåŠ¡çš„æ–¹æ³•æœ‰ä¸€äº›å¥½å¤„ã€‚

# çŸ­ç¯‡å°è¯´

å¦‚æžœä½ æ‡’å¾—é˜…è¯»ä¸€æ­¥æ­¥çš„è§£é‡Šï¼Œè¯·æŸ¥çœ‹ [**Github å›žè´­ç¤ºä¾‹**](https://github.com/kobvel/ng-ngrx-resolve) ä»¥äº†è§£å®Œæ•´çš„å®žçŽ°ã€‚

# é—®é¢˜

æˆ‘ä»¬æ­£åœ¨ç”¨ NgRX æ–¹æ³•ç¼–å†™ä¸€ä¸ª Angular åº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬å¸Œæœ›ç¡®ä¿åœ¨è¿›å…¥ **Profile** é¡µé¢ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰æ•°æ®æ˜¾ç¤ºåœ¨è¯¥ç»„ä»¶ä¸­ã€‚æ‚¨å¯ä»¥ä»Žå®˜æ–¹æ–‡æ¡£ä¸­æŸ¥çœ‹[è·¯ç”±è§£æžå™¨çš„æ ‡å‡†å®žçŽ°ã€‚æˆ‘ä»¬å°†è¿›ä¸€æ­¥äº†è§£å¦‚ä½•é€šè¿‡ NgRX çŠ¶æ€ç®¡ç†æ¥å®žçŽ°è¿™ä¸€ç‚¹ã€‚](https://angular.io/api/router/Resolve)

/app.routes.ts

## å…ˆå†³æ¡ä»¶

æˆ‘ä»¬æ¥çœ‹çœ‹`ProfileComponent` ***ã€‚*** æ¥è‡ª`ApiService` *çš„ç»å…¸è®¢é˜…å¯è§‚å¯Ÿè¢«ç½‘ç»œè°ƒç”¨è¿”å›žã€‚*ä¸ç®¡`ProfileComponent`ä½¿ç”¨è¿™äº›æ•°æ®æ˜¯ä¸ºäº†ä»€ä¹ˆï¼Œè®©æˆ‘ä»¬å‡è®¾æˆ‘ä»¬éœ€è¦åœ¨è¿›å…¥ç»„ä»¶ä¹‹å‰ç¡®å®šæ•°æ®å­˜åœ¨ã€‚

/profile/profile.component.ts

## å®šä¹‰å‡é€Ÿå™¨å’ŒåŠ¨ä½œ

æˆ‘ä¸ªäººå€¾å‘äºŽä»¥é¢å‘ç‰¹å¾çš„ç»“æž„ä¿å­˜æ–‡ä»¶ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†æŠŠæ–°æ–‡ä»¶æ”¾åœ¨ä¸Žæ”¾ç½®`ProfileComponent` ç›¸åŒçš„æ–‡ä»¶å¤¹ä¸­ã€‚è¿™æ˜¯æˆ‘ä»¬åˆ›å»ºäº†`profile.reducer.ts`å’Œ`profile.actions.ts`ä¹‹åŽçš„ä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹ç»“æž„ã€‚

é…ç½®æ–‡ä»¶æ–‡ä»¶å¤¹ç»“æž„

*   *profile.component.ts*
*   *profile.component.html*
*   *profile.actions.ts*
*   *profile.reducer.ts*

çœ‹ä¸€çœ‹`profile.actions.ts`

/profile/profile.actions.ts

*   `IProfileActions` â€”æˆ‘ä»¬å°†ç”¨æ¥æ“ä½œä¸Žé…ç½®æ–‡ä»¶å®žä½“ç›¸å…³çš„æ•°æ®çš„åŠ¨ä½œåˆ—è¡¨ã€‚å¦‚æžœéœ€è¦æ‰©å±•åŠŸèƒ½ï¼Œå¯ä»¥æ·»åŠ `PORFILE_INIT`ã€`PROFILE_CHANGE`ç­‰åŠ¨ä½œã€‚ç›®å‰ï¼Œæˆ‘ä»¬å¯¹è§¦å‘é…ç½®æ–‡ä»¶æ•°æ®æ›´æ–°çš„æ“ä½œæ²¡æœ‰é—®é¢˜ã€‚
*   `UpdateAction` â€”æ˜¯æˆ‘ä»¬å®šä¹‰çš„å•ä¸€åŠ¨ä½œç±»åž‹ï¼Œç”¨æ¥æè¿°èŽ·å–æ–°æ•°æ®çš„åŠ¨ä½œ(`IProfileData`ç±»åž‹)ã€‚

çŽ°åœ¨è®©æˆ‘ä»¬åœ¨`profile.reducer.ts`ä¸­å¤„ç†è¿™ä¸ªåŠ¨ä½œ

/profile/profile.reducer.ts

*   `IProfileState` â€”æè¿°æˆ‘ä»¬å°†å¦‚ä½•æ‰©å±•åŸºæœ¬å‡é€Ÿå™¨çš„åº”ç”¨ã€‚
*   `initialState`â€”`ProfileData`çš„é»˜è®¤å€¼
*   `reducer` â€”å¤„ç†å•ä¸ªåŠ¨ä½œ(æ›´æ–°)ä»¥æè¿°åœ¨ç”¨ä¸€äº›æœ‰æ•ˆè´Ÿè½½è§¦å‘åŠ¨ä½œåŽçš„çŠ¶æ€å˜åŒ–

## å»¶ä¼¸æ ¹éƒ¨å‡é€Ÿå™¨

/app.state.ts

æˆ‘ä»¬é€šè¿‡å°† reducer *å¯¹è±¡*æ·»åŠ åˆ° all `reducers` (LOC: 11 `app.state.ts`)æ¥ç»„æˆåº”ç”¨ç¨‹åºçš„æ ¹çŠ¶æ€ã€‚

/app.module.ts

æœ€åŽä¸€ä»¶äº‹â€”â€”æˆ‘ä»¬ç”¨åœ¨`storeReducers` (LOC: 8 `app.module.ts`)ä¹‹å‰åˆ›å»ºçš„ reducers æ¥å®šä¹‰ StoreModuleã€‚

# è®¾ç½®è·¯å¾„è§£æžå™¨

çŽ°åœ¨ï¼Œè®©æˆ‘ä»¬å°† resolver æ”¾åœ¨æˆ‘ä»¬å¸Œæœ›ç­‰å¾…æ•°æ®åŠ è½½çš„è·¯çº¿ä¸Šã€‚

/app.routes.ts

ç»§ç»­ç”¨ç›¸åº”çš„ç±»åˆ›å»º`profile.resolver.ts`ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šé¢çš„`app.routes.ts`ä¸­åœ¨ LOC: 8 ä¸Šå‘½åçš„é‚£æ ·ã€‚è¿™ä¸€è¡Œè¡¨ç¤ºç­‰å¾…å¯¼èˆªåˆ°`/profile`è·¯çº¿ï¼Œç›´åˆ°æ•°æ®åœ¨`ProfileResolver`ä¸­è¢«è§£æžï¼Œæˆ‘ä»¬é©¬ä¸Šå°±è¦å®žçŽ°ã€‚

/profile.resolver.ts

æ–°åˆ›å»ºçš„å®žçŽ°`[Resolve](https://angular.io/api/router/Resolve)`æŽ¥å£çš„ç±»ï¼Œå®ƒè¦æ±‚æˆ‘ä»¬å®šä¹‰`*resolve*`åŠŸèƒ½ã€‚è¯¥å‡½æ•°å¯ä»¥ç›´æŽ¥è¿”å›ž**æ‰¿è¯º**ã€**å¯è§‚æµ‹**æˆ–é¢„æœŸç±»åž‹ã€‚

**åŠŸèƒ½** `**waitForProfileDataToLoad**`:

*LOC 23:* Subscribe store ç›‘å¬`profile`å¯¹è±¡å˜åŒ–ã€‚

*LOC 24:* ä»Žæ™®é€š`profile`å¯¹è±¡ä¸­èŽ·å–å”¯ä¸€çš„`profileData`æ˜ å°„å€¼

*LOC 25:* å¿½ç•¥ä¸å­˜åœ¨`profileData`çš„æ‰€æœ‰è§¦å‘å™¨

*LOC 26:* take(1) â€”ä»…èŽ·å–ç¬¬ä¸€ä¸ªå€¼ï¼Œåªè¦æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå€¼æ¥è§£æžè·¯å¾„

**åŠŸèƒ½** `**initProfileData**`:

èŽ·å–ä½äºŽå•†åº—ä¸­çš„`profile`å¯¹è±¡çš„ç¬¬ä¸€ä¸ªå€¼ã€‚å¦‚æžœæ²¡æœ‰å€¼:

1.  ä½¿ç”¨`getProfileData()`èŽ·å–æ•°æ®
2.  å°†å…¶è½¬æ¢ä¸º**æ‰¿è¯º**(æˆ‘ä»¬åªéœ€è¦ä¸€æ¬¡ï¼Œæ‰€ä»¥æ²¡æœ‰è®¢é˜…å¯è§‚å¯Ÿçš„ç‚¹)
3.  ç”¨æˆ‘ä»¬åˆšä»ŽæœåŠ¡å™¨ä¸Šå¾—åˆ°çš„`data`æ´¾é£`UpdateAction`

## è·¯ç”±è§£æžå™¨ç»“è®º

æˆ‘ä»¬é€šè¿‡ä»ŽæœåŠ¡å™¨èŽ·å–æ•°æ®æ¥åˆå§‹åŒ–æ•°æ®ï¼Œå¹¶ä¸ºåº”ç”¨ç¨‹åºå•†åº—åˆ†æ´¾æ–°çš„çŠ¶æ€ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å‘Šè¯‰æˆ‘ä»¬çš„ **resolve** å‡½æ•°ç›‘å¬å•†åº—çš„å˜åŒ–ï¼Œå¹¶è¿”å›ž **Observable** å’Œå®ƒå°†åœ¨å•†åº—ä¸­æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªéžç©ºçš„`ProfileData`ã€‚

# åœ¨ç»„ä»¶ä¸­ä½¿ç”¨è·¯çº¿æ•°æ®

æœ€åŽï¼Œæˆ‘ä»¬ä»Žè·¯çº¿å¿«ç…§ä¸­èŽ·å–`profileData`ï¼Œå‡è®¾**å¿…é¡»**å­˜åœ¨äºŽæ­¤ã€‚

/profile/profile.component.ts

# ç»“è®º

NgRx é©±åŠ¨çš„åº”ç”¨ç¨‹åºä½¿æ•´ä¸ªåº”ç”¨ç¨‹åºçš„æ•°æ®æµè¿‡ç¨‹éžå¸¸æ¸…æ™°ã€‚æˆ‘å¸Œæœ›è¿™èƒ½ç»™ä½ ä¸€äº›è§£å†³è·¯å¾„åˆ†è§£é—®é¢˜çš„æ¨¡å¼ã€‚

è¿™é‡Œæœ‰å‡ ä»¶äº‹ä½ ä¹Ÿå¯ä»¥åšï¼Œä»¥æ”¹å–„ä½ çš„åº”ç”¨ç¨‹åºä½“éªŒ:

*   `**initProfileData**` **â€”** å¯ä»¥ç§»åŠ¨æˆ–ç§»é™¤ï¼Œå¦‚æžœä½ æœ‰ä¸€äº›ä¸åŒçš„åœ°æ–¹æ¥åˆå§‹åŒ–æ•°æ®ã€‚
*   æ‚¨å¯ä»¥å®žçŽ° spinner æ¥æ˜¾ç¤ºè·¯ç”±è§£æžå™¨çš„è¿è¡Œæƒ…å†µã€‚[å…¨å›žè´­ç¤ºä¾‹](https://github.com/kobvel/ng-ngrx-resolve/blob/master/src/app/app.component.html#L7)ä¸­æœ‰ä¸€äº›åŸºæœ¬å®žçŽ°ã€‚
*   å¦‚æžœæ‚¨å¸Œæœ›ä»Žå¦ä¸€ä¸ªåœ°æ–¹æ›´æ”¹æ•°æ®ï¼Œæ‚¨çš„ç»„ä»¶å¯ä»¥ç›´æŽ¥è®¢é˜… storeã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥è½¬æ¢`ProfileResolver`ä»¥è¿”å›ž**å¸ƒå°”å€¼**è€Œä¸æ˜¯æ•°æ®ã€‚å¯èƒ½æ˜¯æŽŒæ¡è¿™ä¸ªè¯é¢˜çš„å¾ˆå¥½çš„å®¶åº­ä½œä¸šðŸ˜œã€‚

## [Github å›žè´­ç¤ºä¾‹](https://github.com/kobvel/ng-ngrx-resolve)

> æ„Ÿè°¢é˜…è¯»ï¼å¦‚æžœä½ æƒ³è®©æˆ‘å†™æ›´å¤šç±»ä¼¼çš„æ•…äº‹ï¼ŒæŽ¨èè¿™ç¯‡æ–‡ç« (ç‚¹å‡»â¤æŒ‰é’®)ã€‚
> 
> æŠŠä½ çš„æƒ³æ³•å†™åœ¨è¯„è®ºé‡Œï¼Œè®¢é˜…æˆ‘çš„[åª’ä»‹](/@kobvel)å¯»æ‰¾æ›´å¤šæ•…äº‹ã€‚