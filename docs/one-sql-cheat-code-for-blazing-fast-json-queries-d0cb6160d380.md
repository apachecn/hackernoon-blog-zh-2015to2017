# ä¸€ä¸ªå¿«é€Ÿ JSON æŸ¥è¯¢çš„ SQL æ¬ºéª—ä»£ç 

> åŸæ–‡ï¼š<https://medium.com/hackernoon/one-sql-cheat-code-for-blazing-fast-json-queries-d0cb6160d380>

## éæŒä¹…åŒ–è®¡ç®—åˆ—ç´¢å¼•å¦‚ä½•æé«˜ JSON æŸ¥è¯¢çš„æ€§èƒ½

![](img/9fc141063c55cd5c7dfcb97c219a86be.png)

æœ€è¿‘åœ¨[SQL](https://blog.bertwagner.com/video-json-usage-and-performance-in-sql-server-2016-524edcc5a610)æœåŠ¡å™¨ 2016[a](https://blog.bertwagner.com/when-is-it-appropriate-to-store-json-in-sql-server-8ed1eed1520d)[lot](https://blog.bertwagner.com/who-stuck-these-letters-in-my-datetimes-b42cbd6e987d)åš JSONã€‚

è®¸å¤šäººå¯¹åœ¨ [SQL Server](https://hackernoon.com/tagged/sql-server) ä¸­ä½¿ç”¨ [JSON](https://hackernoon.com/tagged/json) æ„Ÿåˆ°çŠ¹è±«çš„ä¸€ä¸ªåŸå› æ˜¯ï¼Œä»–ä»¬è®¤ä¸ºæŸ¥è¯¢å®ƒä¸€å®šå¾ˆæ…¢â€”â€”SQL åº”è¯¥æ“…é•¿å…³ç³»æ•°æ®ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²è§£æï¼Œå¯¹å—ï¼Ÿ

äº‹å®è¯æ˜ï¼Œç‹¬ç«‹çš„ SQL Server JSON å‡½æ•°çš„æ€§èƒ½éå¸¸å¥½ã€‚æ›´å¥½çš„æ˜¯ï¼Œé€šè¿‡åœ¨ JSON è§£æçš„è®¡ç®—åˆ—ä¸Šä½¿ç”¨ç´¢å¼•ï¼Œå¯ä»¥ä½¿é’ˆå¯¹ JSON æ•°æ®çš„æŸ¥è¯¢ä»¥å¯ç¬‘çš„é€Ÿåº¦è¿è¡Œã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³çœ‹çœ‹ SQL æ˜¯å¦‚ä½•ä»¥å¦‚æ­¤é«˜çš„æ€§èƒ½è§£æ*çš„ã€‚

**â€œParseâ€åœ¨è¿™é‡Œå…¶å®æ˜¯ä¸€ä¸ªè°è¨€â€”â€”å®ƒåœ¨å¹•ååšåˆ«çš„äº‹æƒ…ã€‚ä½ ä¼šæ˜ç™½æˆ‘çš„æ„æ€çš„ï¼Œç»§ç»­è¯»ï¼*

# SQL Server ä¸­çš„è®¡ç®—åˆ—

è®© JSON ç´¢å¼•åœ¨ SQL server ä¸Šå·¥ä½œçš„å”¯ä¸€æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ª[è®¡ç®—åˆ—](https://technet.microsoft.com/en-us/library/ms191250(v=sql.105).aspx)ã€‚è®¡ç®—åˆ—åŸºæœ¬ä¸Šæ˜¯æ‰§è¡Œå‡½æ•°æ¥è®¡ç®—å…¶å€¼çš„åˆ—ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŒ…å«ä¸€äº›æ±½è½¦ JSON æ•°æ®çš„è¡¨:

```
DROP TABLE IF EXISTS dbo.DealerInventory;
CREATE TABLE dbo.DealerInventory
(
  Id int IDENTITY(1,1) PRIMARY KEY,
  Year int,
  JsonData nvarchar(300)
);INSERT INTO dbo.DealerInventory (Year, JsonData) VALUES (2017, '{ "Make" : "Volkswagen", "Model" : "Golf" }');INSERT INTO dbo.DealerInventory (Year, JsonData) VALUES (2017, '{ "Make" : "Honda", "Model" : "Civic" }');INSERT INTO dbo.DealerInventory (Year, JsonData) VALUES (2017, '{ "Make" : "Subaru", "Model" : "Impreza" }');SELECT * FROM dbo.DealerInventory;/* Output:
Id    Year     JsonData
----- -------- ---------------------------------------------
1     2017     { "Make" : "Volkswagen", "Model" : "Golf" }
2     2017     { "Make" : "Honda", "Model" : "Civic" }
3     2017     { "Make" : "Subaru", "Model" : "Impreza" }
*/
```

æˆ‘ä»¬å¯ä»¥å‘è¡¨ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„è®¡ç®—åˆ—â€œMake â€,å®ƒä»æ¯ä¸€è¡Œçš„ JSON å­—ç¬¦ä¸²ä¸­è§£æå¹¶æå– Make å±æ€§:

```
ALTER TABLE dbo.DealerInventory
ADD Make AS JSON_VALUE(JsonData, '$.Make');SELECT * FROM dbo.DealerInventory;/* Output:
Id Year  JsonData                                    Make
-- ----- ------------------------------------------- ----------
1  2017  { "Make" : "Volkswagen", "Model" : "Golf" } Volkswagen
2  2017  { "Make" : "Honda", "Model" : "Civic" }     Honda
3  2017  { "Make" : "Subaru", "Model" : "Impreza" }  Subaru
*/
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸Šé¢çš„ Make computed åˆ—æ˜¯éæŒä¹…åŒ–çš„ï¼Œè¿™æ„å‘³ç€å®ƒçš„å€¼æ°¸è¿œä¸ä¼šå­˜å‚¨åˆ°æ•°æ®åº“ä¸­(ä¹Ÿå¯ä»¥åˆ›å»ºæŒä¹…åŒ–çš„è®¡ç®—åˆ—ï¼Œä½†è¿™æ˜¯å¦ä¸€ä¸ªæ—¶é—´çš„ä¸»é¢˜)ã€‚ç›¸åï¼Œæ¯æ¬¡å¯¹æˆ‘ä»¬çš„`dbo.DealerInventory`è¡¨è¿è¡ŒæŸ¥è¯¢æ—¶ï¼ŒSQL Server éƒ½ä¼šè®¡ç®—æ¯ä¸€è¡Œçš„å€¼ã€‚

è¿™æ ·åšçš„æ€§èƒ½ä¸æ˜¯å¾ˆå¥½â€”â€”å®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ ‡é‡å‡½æ•°ï¼Œé’ˆå¯¹æˆ‘ä»¬è¾“å‡ºçš„æ¯ä¸€è¡Œè¿è¡Œ:(ã€‚ä½†æ˜¯ï¼Œå½“æ‚¨å°†è®¡ç®—åˆ—ä¸ç´¢å¼•ç»“åˆä½¿ç”¨æ—¶ï¼Œä¼šå‘ç”Ÿä¸€äº›æœ‰è¶£çš„äº‹æƒ…ã€‚

# æ˜¯æ—¶å€™æ·±å…¥äº†è§£ DBCCÂ·ä½©å¥‡äº†

`DBCC Page`æ˜¯ä¸€ä¸ªæœªè®°å½•çš„ SQL Server å‡½æ•°ï¼Œæ˜¾ç¤ºäº†å­˜å‚¨åœ¨ SQL é¡µé¢æ–‡ä»¶ä¸­çš„åŸå§‹æ•°æ®çš„æ ·å­ã€‚é¡µé¢æ–‡ä»¶æ˜¯ SQL Server å­˜å‚¨æ•°æ®çš„æ–¹å¼ã€‚

åœ¨æœ¬æ–‡çš„å…¶ä½™éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†ç ”ç©¶æ•°æ®é¡µ(å­˜å‚¨ SQL ä¸­å®é™…è¡¨æ•°æ®çš„åœ°æ–¹)å’Œç´¢å¼•é¡µ(å­˜å‚¨æˆ‘ä»¬çš„ç´¢å¼•æ•°æ®çš„åœ°æ–¹)å¦‚ä½•å—åˆ°éæŒä¹…åŒ–è®¡ç®—åˆ—çš„å½±å“â€”â€”ä»¥åŠå®ƒä»¬å¦‚ä½•ä½¿ JSON æŸ¥è¯¢è¶…å¿«ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬ç°æœ‰çš„æ•°æ®ã€‚æˆ‘ä»¬é¦–å…ˆæ‰“å¼€è·Ÿè¸ªæ ‡å¿— 3604ï¼Œå¹¶ä½¿ç”¨`DBCC IND`æ¥è·å–æ•°æ®çš„é¡µé¢ idã€‚å…³äº`DBCC IND`å’Œ`DBCC PAGE`ä¸­åˆ—å®šä¹‰çš„æ›´å¤šç»†èŠ‚å¯ä»¥åœ¨ [Paul Randal å…³äºä¸»é¢˜](https://www.sqlskills.com/blogs/paul/inside-the-storage-engine-using-dbcc-page-and-dbcc-ind-to-find-out-if-page-splits-ever-roll-back/)çš„åšå®¢æ–‡ç« ä¸­æ‰¾åˆ°ã€‚

```
DBCC TRACEON(3604);-- "Sandbox" is the name of my database
DBCC IND('Sandbox','dbo.DealerInventory',-1);
```

![](img/a8b8c736678c5aff21ff738933578826.png)

å¦‚æœæ‚¨æŸ¥çœ‹ä¸Šé¢çš„ç»“æœï¼Œç¬¬ 2 è¡ŒåŒ…å«æˆ‘ä»¬çš„æ•°æ®é¡µé¢(ç”± PageType = 1 è¡¨ç¤º),è¯¥é¡µé¢çš„ PagePID æ˜¯ 305088(å¦‚æœæ‚¨åœ¨å®¶ç©ï¼Œæ‚¨çš„ PagePID å¾ˆå¯èƒ½æ˜¯åˆ«çš„ä»€ä¹ˆ)ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨`DBCC PAGE`æ¥æŸ¥æ‰¾ PagePIDï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°è¿™æ ·çš„ç»“æœ:

```
DBCC PAGE('Sandbox',1,305088,3) WITH TABLERESULTS
```

![](img/1daf43f24e9f4918a216a4912c59d925.png)

ä½ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç”¨çº¢è‰²çªå‡ºæ˜¾ç¤ºçš„ä¸‰è¡Œæ•°æ®ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„é‡è¦ä¸€ç‚¹æ˜¯ï¼Œæˆ‘ä»¬è§£æçš„â€œMakeâ€å€¼çš„è®¡ç®—åˆ—æ˜¯çœŸæ­£éæŒä¹…åŒ–çš„ï¼Œå¹¶ä¸”åœ¨å“ªé‡Œéƒ½æ‰¾ä¸åˆ°ï¼Œè¿™æ„å‘³ç€å®ƒå¿…é¡»åœ¨æŸ¥è¯¢æ‰§è¡ŒæœŸé—´ä¸ºæ¯ä¸€è¡Œç”Ÿæˆã€‚

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬å‘éæŒä¹…åŒ–è®¡ç®—åˆ—æ·»åŠ ä¸€ä¸ªç´¢å¼•ï¼Œç„¶åå†æ¬¡è¿è¡Œ`DBCC IND`ä¼šæ€ä¹ˆæ ·:

```
CREATE NONCLUSTERED INDEX IX_ParsedMake ON dbo.DealerInventory (Make)DBCC IND('Sandbox','dbo.DealerInventory',-1);
```

![](img/5e4899680d08a03fcbca2ab895fcf9a4.png)

æ‚¨ç°åœ¨ä¼šæ³¨æ„åˆ°ï¼Œé™¤äº†æ•°æ®é¡µ 305088 (PageType = 1)ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªç´¢å¼•é¡µ 305096 (PageType = 2)ã€‚å¦‚æœæˆ‘ä»¬åŒæ—¶æ£€æŸ¥æ•°æ®é¡µå’Œç´¢å¼•é¡µï¼Œæˆ‘ä»¬ä¼šå‘ç°ä¸€äº›æœ‰è¶£çš„äº‹æƒ…:

```
DBCC PAGE('Sandbox',1,305088,3) WITH TABLERESULTSDBCC PAGE('Sandbox',1,305096,3) WITH TABLERESULTS
```

æˆ‘ä»¬çš„æ•°æ®é¡µé¢æ²¡æœ‰ä»»ä½•å˜åŒ–:

![](img/b6c3735bfa652adec1e64ed3f8f5266a.png)

ä½†æ˜¯æˆ‘ä»¬çš„ç´¢å¼•é¡µé¢åŒ…å«â€œMakeâ€åˆ—çš„è§£æå€¼:

![](img/fa9a55cd383b1112768936e1f4cdda58.png)

# è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿæˆ‘ä»¥ä¸ºéæŒä¹…åŒ–çš„è®¡ç®—åˆ—ä¸ä¼šä¿å­˜åˆ°ç£ç›˜ä¸Šï¼

å®Œå…¨æ­£ç¡®:æˆ‘ä»¬çš„éæŒä¹…åŒ–è®¡ç®—åˆ—â€œMakeâ€æ²¡æœ‰ä¿å­˜åˆ°ç£ç›˜ä¸Šçš„æ•°æ®é¡µã€‚ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬åœ¨éæŒä¹…åŒ–çš„è®¡ç®—åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼Œè®¡ç®—å€¼*å°†åœ¨ç´¢å¼•é¡µé¢ä¸ŠæŒä¹…åŒ–*ï¼

è¿™åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªä¸ºè®¡ç®—åˆ—å»ºç«‹ç´¢å¼•çš„æ¬ºéª—ä»£ç ã€‚

SQL å°†ä»…åœ¨å‘è¡¨ä¸­æ’å…¥æˆ–æ›´æ–°è¡Œæ—¶(æˆ–åœ¨åˆå§‹ç´¢å¼•åˆ›å»ºæœŸé—´)è®¡ç®—â€œMakeâ€å€¼â€”æˆ‘ä»¬è®¡ç®—åˆ—çš„æ‰€æœ‰æœªæ¥æ£€ç´¢éƒ½å°†æ¥è‡ªé¢„å…ˆè®¡ç®—çš„ç´¢å¼•é¡µã€‚

è¿™å°±æ˜¯ SQL èƒ½å¤Ÿå¦‚æ­¤å¿«é€Ÿåœ°è§£æç´¢å¼• JSON å±æ€§çš„åŸå› ï¼›SQL Server å¯ä»¥åœ¨ç´¢å¼•ä¸­æŸ¥æ‰¾é¢„å…ˆè§£æçš„å€¼ï¼Œå¹¶ä»¥æƒŠäººçš„é€Ÿåº¦è¿”å›æ­£ç¡®çš„æ•°æ®ï¼Œè€Œä¸éœ€è¦æ‰«æè¡¨å¹¶è§£æè¡¨ä¸­æ¯è¡Œçš„ JSON æ•°æ®ã€‚

å°±ä¸ªäººè€Œè¨€ï¼Œæˆ‘è®¤ä¸ºè¿™ä½¿å¾— JSON åœ¨ SQL Server 2016 ä¸­æ›´å®¹æ˜“(å’Œå®ç”¨)ä½¿ç”¨ã€‚å³ä½¿æˆ‘ä»¬åœ¨æ•°æ®åº“ä¸­å­˜å‚¨äº†å¤§é‡çš„ JSON å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥ç´¢å¼•å•ä¸ªå±æ€§å¹¶ä»¥æƒŠäººçš„é€Ÿåº¦è¿”å›ç»“æœã€‚

å–œæ¬¢è¿™ç¯‡æ–‡ç« å—ï¼Ÿè¯·æ¨èç»™å®ƒä¸€é¢—ç»¿è‰²çš„å¿ƒğŸ’š*ä¸‹æ–‡ã€‚*

*ä½ å¯¹ä½ çš„è¡¨ä½¿ç”¨è®¡ç®—åˆ—ç´¢å¼•å—ï¼Ÿåœ¨ä¸‹é¢çš„è¯„è®ºä¸­å‘Šè¯‰æˆ‘ä»–ä»¬çš„æƒ…å†µå§ï¼*

[![](img/50ef4044ecd4e250b5d50f368b775d38.png)](http://bit.ly/HackernoonFB)[![](img/979d9a46439d5aebbdcdca574e21dc81.png)](https://goo.gl/k7XYbx)[![](img/2930ba6bd2c12218fdbbf7e02c8746ff.png)](https://goo.gl/4ofytp)

> [é»‘å®¢ä¸­åˆ](http://bit.ly/Hackernoon)æ˜¯é»‘å®¢å¦‚ä½•å¼€å§‹ä»–ä»¬çš„ä¸‹åˆã€‚æˆ‘ä»¬æ˜¯ [@AMI](http://bit.ly/atAMIatAMI) å®¶åº­çš„ä¸€å‘˜ã€‚æˆ‘ä»¬ç°åœ¨[æ¥å—æŠ•ç¨¿](http://bit.ly/hackernoonsubmission)å¹¶ä¹æ„[è®¨è®ºå¹¿å‘Š&èµåŠ©](mailto:partners@amipublications.com)æœºä¼šã€‚
> 
> å¦‚æœä½ å–œæ¬¢è¿™ä¸ªæ•…äº‹ï¼Œæˆ‘ä»¬æ¨èä½ é˜…è¯»æˆ‘ä»¬çš„[æœ€æ–°ç§‘æŠ€æ•…äº‹](http://bit.ly/hackernoonlatestt)å’Œ[è¶‹åŠ¿ç§‘æŠ€æ•…äº‹](https://hackernoon.com/trending)ã€‚ç›´åˆ°ä¸‹ä¸€æ¬¡ï¼Œä¸è¦æŠŠä¸–ç•Œçš„ç°å®æƒ³å½“ç„¶ï¼

![](img/be0ca55ba73a573dce11effb2ee80d56.png)