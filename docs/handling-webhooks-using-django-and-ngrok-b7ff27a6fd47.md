# ä½¿ç”¨ Django å’Œ ngrok å¤„ç† webhooks

> åŸæ–‡ï¼š<https://medium.com/hackernoon/handling-webhooks-using-django-and-ngrok-b7ff27a6fd47>

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Django å¤„ç† webhookï¼Œåœ¨ [GitHub](https://hackernoon.com/tagged/github) ä¸­åˆ›å»ºä¸€ä¸ª webhookï¼Œå¹¶ä½¿ç”¨ ngrok åœ¨æ‚¨çš„æœ¬åœ°æœºå™¨ä¸Šæµ‹è¯• web hookã€‚ä½†æ˜¯é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹ webhooksã€‚

å¦‚æœä½ å·²ç»ç†Ÿæ‚‰ webhooksï¼Œé‚£ä¹ˆå¯ä»¥è·³è¿‡ç¬¬ä¸€éƒ¨åˆ†ã€‚

# ä»€ä¹ˆæ˜¯ webhooksï¼Ÿ

å‡è®¾æ‚¨æ­£åœ¨ç¼–å†™ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œéœ€è¦åœ¨å¦ä¸€ä¸ªç³»ç»Ÿä¸­å‘ç”Ÿäº‹ä»¶æ—¶å¾—åˆ°é€šçŸ¥ã€‚äº‹ä»¶å¯èƒ½æ˜¯ç”¨æˆ·å‘é€æ¨æ–‡æˆ–æŸä¸ªå•†å“çš„ä»·æ ¼å‘ç”Ÿå˜åŒ–ã€‚

çŸ¥é“äº‹ä»¶ä½•æ—¶å‘ç”Ÿçš„ä¸€ä¸ªæ–¹æ³•æ˜¯ç»å¸¸æ£€æŸ¥ã€‚ä¾‹å¦‚ï¼Œä½ çš„åº”ç”¨ç¨‹åºå¯ä»¥æ¯ 5 åˆ†é’Ÿå‘ Twitter å‘å‡ºä¸€ä¸ªè¯·æ±‚ï¼Œè¯¢é—®â€œç”¨æˆ·*å·²ç»å‘å¸ƒäº†ä»€ä¹ˆå—ï¼Ÿâ€è¿™è¢«ç§°ä¸ºè½®è¯¢ï¼Œå®ƒä¼šå¯¹æ‚¨çš„æœåŠ¡å™¨é€ æˆè´Ÿæ‹…ï¼Œå› ä¸ºæ‚¨å¿…é¡»ä¸æ–­åœ°å‘å¤–éƒ¨æœåŠ¡å‘å‡ºè¯·æ±‚ã€‚*

å¦ä¸€ç§çŸ¥é“äº‹ä»¶å·²ç»å‘ç”Ÿçš„æ–¹æ³•æ˜¯è®©å…¶ä»–æœåŠ¡åœ¨äº‹æƒ…å‘ç”Ÿå˜åŒ–æ—¶é€šçŸ¥ä½ çš„åº”ç”¨ç¨‹åºã€‚è¿™å¯ä»¥é€šè¿‡ä½¿ç”¨ **webhooks** æ¥å®Œæˆã€‚ä½¿ç”¨ webhooksï¼Œæ‚¨ä¸å†éœ€è¦æ¯ 5 åˆ†é’Ÿæˆ–æ¯å¤©è¿›è¡Œä¸€æ¬¡æŠ•ç¥¨ã€‚ç›¸åï¼Œä½ çš„åº”ç”¨ç¨‹åº**å®æ—¶æ¥æ”¶äº‹ä»¶**ã€‚

# å¤„ç† GitHub webhooks

GitHub æœ‰å¤ªå¤šçš„äº‹ä»¶å¯ä»¥è§¦å‘ webhooksã€‚æˆ‘ä»¬è¦å¤„ç†çš„äº‹ä»¶æ˜¯é»˜è®¤çš„`push`äº‹ä»¶ï¼Œå½“ç”¨æˆ·å°†æäº¤ã€åˆ†æ”¯æˆ–æ ‡è®°æ¨é€åˆ° GitHub å­˜å‚¨åº“æ—¶ä¼šå‘ç”Ÿè¯¥äº‹ä»¶ã€‚

è®©æˆ‘ä»¬å†™ä¸€äº›ä»£ç æ¥å¤„ç† GitHub çš„ webhooksã€‚æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ª Django åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªè§†å›¾å‡½æ•°ã€‚ç¡®ä¿å°†è¿™ä¸ªè§†å›¾è¿æ¥åˆ° URL `/hooks/handle_github`ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªè§†å›¾å‡½æ•°ï¼Œå®ƒå°†æ ¹æ® GitHub æ–‡æ¡£ä¸­çš„è¯´æ˜å¤„ç† GitHub webhooks [ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½ éœ€è¦é¦–å…ˆæ·»åŠ ä¸€ä¸ª`GITHUB_WEBHOOK_SECRET`åˆ°ä½ çš„è®¾ç½®æ–‡ä»¶ä¸­ã€‚æŠŠè¿™ä¸ªå½“ä½œä½ çš„ webhook çš„å¯†ç ï¼Œæ‰€ä»¥ç”¨ä¸€ä¸ªåŒ…å«å¾ˆå¤šéšæœºå­—ç¬¦çš„é•¿å­—ç¬¦ä¸²ã€‚å¦å¤–ï¼Œè®°ä½å®ƒï¼Œå› ä¸ºæˆ‘ä»¬ä»¥åä¼šç”¨åˆ°å®ƒã€‚](https://developer.github.com/webhooks/creating/)

æ¥è‡ª GitHub çš„è¯·æ±‚é€šè¿‡`handle_github_hook`æŸ¥çœ‹åŠŸèƒ½è¿›å…¥æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚è§†å›¾ç¡®ä¿è¯·æ±‚å¾—åˆ°æˆæƒï¼ŒåŠ è½½æœ‰æ•ˆè´Ÿè½½ JSONï¼Œå¯¹æœ‰æ•ˆè´Ÿè½½åšä¸€äº›æœ‰ç”¨çš„äº‹æƒ…ï¼Œå¹¶è¿”å› HTTP å“åº”ã€‚

å½“ç¼–å†™ä½ çš„å¤„ç†ç¨‹åºæ—¶ï¼Œè®°ä½ [GitHub å¸Œæœ›ä½ åœ¨ 30 ç§’å†…å“åº” web hooks](https://developer.github.com/guides/best-practices-for-integrators/#favor-asynchronous-work-over-synchronous)ã€‚å¦‚æœä½ éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡å¯ä»¥å¿«é€Ÿå®Œæˆï¼Œé‚£ä¹ˆå°±åŒæ­¥å®Œæˆã€‚å¦åˆ™æœ€å¥½ä½¿ç”¨[èŠ¹èœ](http://www.celeryproject.org/)æˆ– [RQ](http://python-rq.org/) å°†ä»»åŠ¡æ”¾åœ¨åå°ã€‚

ç°åœ¨æˆ‘ä»¬æœ‰äº†å¤„ç† webhooks çš„ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦æµ‹è¯•å®ƒã€‚

# è¾“å…¥ ngrok

Webhooks éœ€è¦ä¸€äº›å·¥ä½œæ¥è¿›è¡Œæœ¬åœ°æµ‹è¯•ã€‚è¿™æ˜¯å› ä¸ºä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œä»–ä»¬å¸Œæœ›æœ‰ä¸€ä¸ªå¯å…¬å¼€è®¿é—®çš„ URL æ¥å‘é€è¯·æ±‚ï¼Œè€Œæˆ‘ä»¬çš„å¤§å¤šæ•°å¼€å‘ç¬”è®°æœ¬ç”µè„‘éƒ½æ²¡æœ‰è¿™ä¸ªåŠŸèƒ½ã€‚å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªéå¸¸ç®€å•çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå…¬å…± URLï¼Œç›´æ¥æŒ‡å‘æˆ‘ä»¬çš„å¼€å‘æœåŠ¡å™¨: [ngrok](https://ngrok.com/) ã€‚

Ngrok æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œåº”ç”¨ç¨‹åºï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒå°†æ‚¨çš„å¼€å‘æœºå™¨æš´éœ²ç»™äº’è”ç½‘ã€‚è¦å®‰è£… ngrokï¼Œè¯·è½¬åˆ° [ngrok.io](https://ngrok.com/) å¹¶éµå¾ªå…¶å®‰è£…æ­¥éª¤ã€‚ä¸‹è½½è§£å‹å°±è¿™ä¹ˆç®€å•ã€‚ä½ å»åšé‚£ä»¶äº‹æ—¶ï¼Œæˆ‘ä¼šç­‰ç€çš„ã€‚

> ğŸµå±é™©ä¸»é¢˜æ›²ğŸµ

ngrok ç°åœ¨å®‰è£…äº†å—ï¼Ÿå¤ªå¥½äº†ï¼è¦è¿è¡Œå®ƒï¼Œè¯·æ‰“å¼€æ‚¨çš„ç»ˆç«¯å¹¶è¾“å…¥ä»¥ä¸‹å†…å®¹ã€‚

```
ngrok http 8000
```

è¿™åº”è¯¥ä¼šå¯åŠ¨ä¸€ä¸ªè¿æ¥åˆ°æœ¬åœ° HTTP ç«¯å£çš„å®‰å…¨éš§é“ã€‚å®ƒçœ‹èµ·æ¥ä¼šåƒè¿™æ ·:

```
ngrok by [@inconshreveable](http://twitter.com/inconshreveable)                                                                                                                                         (Ctrl+C to quit)Session Status                online
Version                       2.1.18
Region                        United States (us)
Web Interface                 [http://127.0.0.1:4041](http://127.0.0.1:4041)
Forwarding                    [http://dda5f8fd.ngrok.io](http://dda5f8fd.ngrok.io) -> localhost:8000
Forwarding                    [https://dda5f8fd.ngrok.io](https://dda5f8fd.ngrok.io) -> localhost:8000Connections                   ttl     opn     rt1     rt5     p50     p90
                              0       0       0.00    0.00    0.00    0.00
```

è½¬å‘ URL[http://DDA 5 F8 FD . ngrok . io](http://dda5f8fd.ngrok.io)æ˜¯æˆ‘å°†ç”¨äº webhook çš„ URLã€‚æ‚¨çš„ URL ä¼šæœ‰æ‰€ä¸åŒï¼Œæ‰€ä»¥ä½¿ç”¨ ngrok æä¾›çš„ä»»ä½•ä¸œè¥¿ã€‚

# è®¾ç½®æˆ‘ä»¬çš„ç½‘é¡µæŒ‚é’©

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä»£ç æ¥å¤„ç† webhooks *å’Œ*ä¸€ä¸ªå¯å…¬å¼€è®¿é—®çš„ URLï¼Œè®©æˆ‘ä»¬åœ¨ GitHub ä¸­è®¾ç½®ä¸€ä¸ª webhookã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ GitHub çš„ API ä»¥ç¼–ç¨‹æ–¹å¼å°† webhook æ·»åŠ åˆ°å­˜å‚¨åº“ä¸­ã€‚äº‹å®ä¸Šï¼Œè¿™å°±æ˜¯ä½ *åº”è¯¥*åšçš„äº‹æƒ…ï¼Œä»¥ä½¿æ•´ä¸ªè¿‡ç¨‹è‡ªåŠ¨åŒ–ã€‚ç„¶è€Œï¼Œæœ¬ç€ç®€æ´çš„ç²¾ç¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡ GitHub UI æ·»åŠ ä¸€ä¸ª webhookã€‚ä¸ºæ­¤ï¼Œè¯·è½¬åˆ° GitHub ä¸­çš„ä¸€ä¸ªå­˜å‚¨åº“ï¼Œé€‰æ‹©è®¾ç½®ï¼Œç„¶åé€‰æ‹© Webhooksã€‚

å°†æ‚¨çš„ ngrok URL + `/hooks/handle_github`æ·»åŠ åˆ°æœ‰æ•ˆè´Ÿè½½ URL å­—æ®µã€‚æ¥ä¸‹æ¥ï¼Œå°† Django è®¾ç½®ä¸­çš„ç§˜å¯†å­—ç¬¦ä¸²æ·»åŠ åˆ°ç§˜å¯†å­—æ®µä¸­ã€‚GitHub ä¼šå‘é€è¿™ä¸ªç§˜å¯†å­—ç¬¦ä¸²ï¼Œè¿™æ ·ä½ å°±å¯ä»¥éªŒè¯è¯·æ±‚æ˜¯å¦çœŸçš„æ¥è‡ªä»–ä»¬ã€‚æœ€åï¼Œé€‰æ‹©ä½ å¸Œæœ› GitHub é€šçŸ¥ä½ çš„åº”ç”¨ç¨‹åºçš„äº‹ä»¶ã€‚å½“ä¸€åˆ‡å°±ç»ªåï¼Œè¡¨å•åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

![](img/192cdf6f68a18610cb5d4efdb3be80e7.png)

Setting up our webhook in GitHub

ç‚¹å‡»æ·»åŠ ç½‘é¡µæŒ‚é’©æŒ‰é’®ï¼Œä½ çš„ç½‘é¡µæŒ‚é’©å°±å¯ä»¥ä½¿ç”¨äº†ã€‚

# æµ‹è¯•å®ƒ

ç»ˆäºåˆ°äº†ç¡®è®¤æ•´ä»¶äº‹æ­£å¸¸è¿ä½œçš„æ—¶å€™äº†ã€‚ä¸ºæ­¤ï¼Œé€šè¿‡è¿è¡Œ`python manage.py runserver`å¯åŠ¨å¼€å‘ Django æœåŠ¡å™¨ã€‚è¿™åº”è¯¥åœ¨ç«¯å£ 8000 ä¸Šå¯åŠ¨æ‚¨çš„æœåŠ¡å™¨ï¼Œè¿™æ˜¯ ngrok æœŸæœ›çš„ç«¯å£ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨ GitHub ä¸­è§¦å‘ä¸€ä¸ªäº‹ä»¶ã€‚å¦‚æœä½ çš„ webhook è¢«é…ç½®ä¸ºå¤„ç†é»˜è®¤çš„`push`äº‹ä»¶ï¼Œé‚£ä¹ˆå°†ä¸€ä¸ªåˆ†æ”¯æ¨é€åˆ° GitHub å°±è¶³å¤Ÿäº†ã€‚

å…‹éš†æ‚¨åˆ›å»º webhook çš„å­˜å‚¨åº“ã€‚ä¾‹å¦‚:

```
$ git clone [https://github.com/grantmcconnaughey/django-field-history.git](https://github.com/grantmcconnaughey/django-field-history.git)
```

ç°åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯ï¼Œå¹¶å°†å…¶æ¨å›åˆ° GitHubã€‚

```
$ git checkout -b webhook_test
$ touch new_file.py
$ git add new_file.py
$ git commit -m "Testing webhooks"
$ git push origin webhook_test
```

è¿™å°†è§¦å‘`push`äº‹ä»¶ï¼ŒGitHub å°†å‘æ‚¨åœ¨å›è´­è®¾ç½®ä¸­è¾“å…¥çš„ ngrok URL å‘å‡ºè¯·æ±‚ã€‚è¿™æ„å‘³ç€æ‚¨åº”è¯¥åœ¨è¿è¡Œ ngrok çš„ç»ˆç«¯ä¸Šçœ‹åˆ°ä¸€äº›æ´»åŠ¨:

```
HTTP Requests
-------------POST /hooks/handle_github/            202 Accepted
```

ä¸‡å²ã€‚ğŸ‰æˆ‘ä»¬å·²ç»æˆåŠŸå¤„ç†äº†ä¸€ä¸ª GitHub webhookã€‚

# ç»“è®º

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è®¨è®ºäº†**ä»€ä¹ˆæ˜¯**ï¼Œä»¥åŠå®ƒä»¬ä¸ºä»€ä¹ˆæœ‰ç”¨ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å‘æ‚¨å±•ç¤ºäº†å¦‚ä½•åœ¨ Django åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨è§†å›¾åŠŸèƒ½å¤„ç† webhooksã€‚ç„¶åæˆ‘å¼€äº†ä¸€ä¸ªè¡ç”Ÿçš„ç©ç¬‘ï¼Œæ¶‰åŠä¸€ä¸ªæ·±å—å–œçˆ±çš„ç¾å›½æ¸¸æˆèŠ‚ç›®ã€‚ä¹‹åï¼Œæˆ‘å‘æ‚¨å±•ç¤ºäº†å¦‚ä½•**é…ç½®æ‚¨çš„æœ¬åœ°å¼€å‘**æœºå™¨æ¥å¤„ç†äº’è”ç½‘ä¸Šçš„ webhooksã€‚æœ€åï¼Œæˆ‘ä»¬è¯æ˜äº†**æ‰€æœ‰è¿™äº›å®é™…ä¸Šéƒ½æœ‰æ•ˆ**ã€‚

æˆ‘å¸Œæœ›ä½ å­¦åˆ°äº†ä¸€äº›ä¸œè¥¿ï¼Œæ„Ÿè°¢ä½ çš„é˜…è¯»ï¼

*è¿™æ®µä»£ç å‡ ä¹ä¸€å­—ä¸å·®åœ°æ‘˜è‡ªæˆ‘çš„é¡¹ç›®*[***Lintly***](https://lintly.com)*ï¼Œä¸€ä¸ªè¿ç»­çš„*[*Python*](https://hackernoon.com/tagged/python)*ä¸ GitHub é›†æˆçš„ä»£ç æ—æŒºæœåŠ¡ã€‚å¦‚æœä½ æƒ³* ***è·Ÿè¸ªä½ çš„ Python ä»£ç è´¨é‡*** *ï¼Œé‚£ä¹ˆ Lintly å¯ä»¥æä¾›å¸®åŠ©ã€‚å» lintly.com çš„*å’Œ[çœ‹çœ‹å§ã€‚](https://lintly.com)

*å¦å¤–ï¼Œå¦‚æœä½ å¯¹æ¨ç‰¹æ„Ÿå…´è¶£ï¼Œè¯·å…³æ³¨æˆ‘*[*@ gmconnaugney*](https://twitter.com/gmconnaughey)*ã€‚*

[![](img/50ef4044ecd4e250b5d50f368b775d38.png)](http://bit.ly/HackernoonFB)[![](img/979d9a46439d5aebbdcdca574e21dc81.png)](https://goo.gl/k7XYbx)[![](img/2930ba6bd2c12218fdbbf7e02c8746ff.png)](https://goo.gl/4ofytp)

> [é»‘å®¢ä¸­åˆ](http://bit.ly/Hackernoon)æ˜¯é»‘å®¢å¦‚ä½•å¼€å§‹ä»–ä»¬çš„ä¸‹åˆã€‚æˆ‘ä»¬æ˜¯ [@AMI](http://bit.ly/atAMIatAMI) å®¶åº­çš„ä¸€å‘˜ã€‚æˆ‘ä»¬ç°åœ¨[æ¥å—æŠ•ç¨¿](http://bit.ly/hackernoonsubmission)å¹¶ä¹æ„[è®¨è®ºå¹¿å‘Š&èµåŠ©](mailto:partners@amipublications.com)æœºä¼šã€‚
> 
> å¦‚æœä½ å–œæ¬¢è¿™ä¸ªæ•…äº‹ï¼Œæˆ‘ä»¬æ¨èä½ é˜…è¯»æˆ‘ä»¬çš„[æœ€æ–°ç§‘æŠ€æ•…äº‹](http://bit.ly/hackernoonlatestt)å’Œ[è¶‹åŠ¿ç§‘æŠ€æ•…äº‹](https://hackernoon.com/trending)ã€‚ç›´åˆ°ä¸‹ä¸€æ¬¡ï¼Œä¸è¦æŠŠä¸–ç•Œçš„ç°å®æƒ³å½“ç„¶ï¼

![](img/be0ca55ba73a573dce11effb2ee80d56.png)