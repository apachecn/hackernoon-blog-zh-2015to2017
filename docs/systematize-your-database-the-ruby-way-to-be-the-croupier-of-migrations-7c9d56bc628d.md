# ç³»ç»ŸåŒ–æ‚¨çš„æ•°æ®åº“â€”â€”æˆä¸ºè¿ç§»ç®¡ç†å‘˜çš„ Ruby æ–¹æ³•ã€‚

> åŸæ–‡ï¼š<https://medium.com/hackernoon/systematize-your-database-the-ruby-way-to-be-the-croupier-of-migrations-7c9d56bc628d>

æƒ³çŸ¥é“èµŒå°ç®¡ç†å‘˜æ˜¯å¦‚ä½•æ´—ç‰Œçš„å—ï¼Ÿä»–ä»¬æŠŠç‰Œåˆ†æˆä¸¤å‰¯ï¼Œç„¶åæŠŠä¸¤å‰¯ç‰Œæ··ä¸ºä¸€å‰¯ã€‚æˆ‘å·²ç»è¯•è¿‡å¾ˆå¤šæ¬¡äº†ï¼Œå¡ç‰‡åˆ°å¤„ä¹±é£ğŸ˜ã€‚ä½†æ˜¯ç°åœ¨æƒ³è±¡ä¸€ä¸‹ï¼Œæ‚¨å¯ä»¥å¯¹æ‚¨çš„æ•°æ®å’Œç»“æ„è¿ç§»è¿›è¡Œæ´—ç‰Œï¼Œè®©å®ƒä»¬æŒ‰ç…§åº”è¯¥çš„é¡ºåºè¿è¡Œâ€¦â€¦é‚£å°†æ˜¯ä¸€ä»¶å¾ˆé…·çš„äº‹æƒ…ï¼

![](img/657dee528927bd053984161e4f9eb297.png)

å½“æ‚¨çš„åº”ç”¨ç¨‹åºå¼€å§‹å˜å¾—è¶Šæ¥è¶Šå¤§æ—¶ï¼Œæ‚¨çš„è¿ç§»æ–‡ä»¶å¤¹å¯èƒ½ä¹Ÿä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ï¼Œå› æ­¤æ‚¨å¯èƒ½éœ€è¦åœ¨ä¸åŒçš„è¡¨ä¹‹é—´ç§»åŠ¨ä¸€äº›æ•°æ®ï¼Œæˆ–è€…ç”šè‡³æ›´æ”¹è¿™äº›æ•°æ®ï¼Œå› ä¸ºæ‚¨çš„ç»“æ„ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ã€‚

æ‚¨ä½•æ—¶è¿›è¡Œè¿ç§»ï¼Ÿé¦–å…ˆæ˜¯æ•°æ®è¿ç§»ï¼Œç„¶åæ˜¯ç»“æ„è¿ç§»ï¼Œè¿˜æ˜¯åè¿‡æ¥ï¼Ÿ

ä½¿ç”¨è¿™äº›æ–¹æ³•ä¸­çš„ä»»ä½•ä¸€ç§ï¼Œéƒ½å®¹æ˜“å‘ç”Ÿä¸€äº›é”™è¯¯:

*   åœ¨ç¬¬ä¸€ç§æ–¹æ³•(æ•°æ®â†’ç»“æ„)ä¸­ï¼Œå¦‚æœæ‚¨éœ€è¦çš„å­—æ®µè¿˜æ²¡æœ‰åˆ›å»º(å› ä¸ºç»“æ„è¿ç§»è¿˜æ²¡æœ‰è¿è¡Œ)ï¼Œæ‚¨ä¼šæ€ä¹ˆåšï¼Ÿ
*   åœ¨ç¬¬äºŒç§æ–¹æ³•(ç»“æ„â†’æ•°æ®)ä¸­ï¼Œå¦‚æœæ‚¨æƒ³è¦å¡«å……çš„å­—æ®µéœ€è¦åœ¨ç»“æ„è¿ç§»ä¸­è¢«åˆ é™¤çš„å¦ä¸€ä¸ªå­—æ®µä¸­çš„æ•°æ®ï¼Œæ‚¨ä¼šæ€ä¹ˆåšï¼Ÿ

è®©æˆ‘ç»™ä½ çœ‹ä¸€ä¸ªä¾‹å­:

*   å‡è®¾æ‚¨æœ‰ä¸€ä¸ª`Post`æ¨¡å‹ï¼Œå®ƒæœ‰ä¸€ä¸ªåä¸º`:deleted`çš„å¸ƒå°”å±æ€§ï¼Œä»£è¡¨è¢«åˆ é™¤çš„`Posts`ï¼›
*   ä¸€æ®µæ—¶é—´åï¼Œä¸€äº›`Posts`è¢«åˆ é™¤ï¼Œä½ è¢«è¦æ±‚ä¸ä»…ä»…çŸ¥é“ä¸€ä¸ª`Post`è¢«åˆ é™¤ï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“`Post`ä½•æ—¶è¢«åˆ é™¤ã€‚å› æ­¤æ‚¨åˆ›å»ºäº†åŒ…å«åˆ é™¤æ—¥æœŸçš„`:deleted_at`å­—æ®µï¼›
*   ç°åœ¨æ‚¨åˆ›å»ºäº†æ•°æ®è¿ç§»ï¼Œå®ƒæœç´¢æ‰€æœ‰è¢«åˆ é™¤çš„`Posts`å¹¶ç»™`:deleted_at`å­—æ®µåŠ ä¸Šæ—¶é—´æˆ³ã€‚åˆ°ç›®å‰ä¸ºæ­¢è¿˜ä¸é”™ï¼›
*   å®Œæˆåï¼Œæ‚¨å¯ä»¥å®‰å…¨åœ°åˆ é™¤æ—§çš„å’Œè¿‡æ—¶çš„`:deleted` å­—æ®µã€‚

å› æ­¤ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬æœ‰ 2 æ¬¡ç»“æ„è¿ç§»(åˆ›å»º`:deleted_at`å­—æ®µå¹¶åˆ é™¤`:deleted`å­—æ®µ)å’Œ 1 æ¬¡æ•°æ®è¿ç§»(å¡«å……`:deleted_at`å­—æ®µ)ã€‚åœ¨æ‚¨è¿è¡Œæ‚¨çš„è¿ç§»ä¹‹å‰ï¼Œè¿™ä¸€åˆ‡éƒ½å¾ˆç¾å¥½ï¼Œå› ä¸ºå½“æ‚¨è¿è¡Œå®Œç»“æ„åŒ–è¿ç§»æ—¶ï¼Œæ‚¨å°†æ²¡æœ‰ä¸€ä¸ª`:deleted`å­—æ®µæ¥æŸ¥è¯¢è¢«åˆ é™¤çš„`Posts`ã€‚

è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘å‘ä½ ä»‹ç»[ç³»ç»ŸåŒ–](https://github.com/RicardoBrazao/systematize)ï¼Œå®ƒæ˜¯è®©ç—›è‹¦æ¶ˆå¤±çš„å®çŸ³ã€‚

# å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

åªéœ€å°†å®ƒæ·»åŠ åˆ°æ‚¨çš„ gem æ–‡ä»¶ä¸­:

```
#Gemfile
gem 'systematize', '~> 0.0.1'
```

æˆ–è€…é€šè¿‡`bundler`å®‰è£…

```
bundle install 'systematize'
```

æƒŠå–œå§ï¼ŒæƒŠå–œå§ï¼Œä½ æœ‰æ–°ä»»åŠ¡äº†ï¼

```
$> bundle exec rake -T
rake systematize:migrate       # Migrate the database
rake systematize:rollback      # Rollback the database (options: STEP=x, VERBOSE=false)
rake systematize:rollback_all  # Rollback all the database
```

æœ‰äº†è¿™ä¸ªï¼Œä½ çš„è¿ç§»å°†è¢«é‡æ–°å®‰æ’ï¼Œå®ƒä»¬å°†æŒ‰æ—¶é—´è·¨åº¦è¿è¡Œï¼Œä»¥ç¡®ä¿ä¸€åˆ‡é¡ºåˆ©ï¼

# è¿™ä¸å…¨æ˜¯å¨±ä¹å’Œæ¸¸æˆï¼Œä½ çŸ¥é“å—ï¼Ÿ

ä¸ºäº†é¡ºåˆ©è¿›è¡Œï¼Œä½ åªéœ€è¦éµå®ˆä¸€äº›è§„åˆ™:

*   è¿ç§»éœ€è¦åœ¨æ­£ç¡®çš„æ–‡ä»¶å¤¹ä¸­ï¼Œå¯¹äºç»“æ„åŒ–è¿ç§»ï¼Œåº”è¯¥åœ¨`db/migrate`ä¸­ï¼Œæ•°æ®è¿ç§»åº”è¯¥åœ¨`db/data`ä¸­ã€‚åƒè¿™æ ·:

```
- app
  |
  |-db
    |-data
    |-migrate
```

*   è¿ç§»éœ€è¦éµå¾ª [Rails](https://hackernoon.com/tagged/rails) çº¦å®š`YYYYMMDDHHMMSS_create_products.rb`

# é—ªè€€çš„æ—¶åˆ»åˆ°äº†

ç°åœ¨ï¼Œå¦‚æœæ‚¨éœ€è¦è¿ç§»[æ•°æ®åº“](https://hackernoon.com/tagged/database)ï¼Œæ‚¨åªéœ€è¿è¡Œ:

```
bundle exec rake systematize:migrate
```

éœ€è¦å›æ»šä¹‹å‰çš„è¿ç§»å—ï¼Ÿæ²¡é—®é¢˜ã€‚

```
bundle exec rake systematize:rollback
```

éœ€è¦å›æ»š 2/3/4 è¿ç§»å—ï¼Ÿæˆ‘æŠ“ä½ä½ äº†ã€‚

```
bundle exec rake systematize:rollback STEP=2
```

æå¾—ä¸€å›¢ç³Ÿï¼Œä½ éœ€è¦é‡æ–°å¼€å§‹ï¼ŸåŠ¨æ‰‹å§ã€‚(è¿ç§»éœ€è¦æ˜¯å¯é€†çš„ğŸ˜…)

```
bundle exec rake systematize:rollback_all
```

åˆ«å¿˜äº†æ‰“ç¢å®ƒğŸ’šæŒ‰é’®ï¼Œå¦‚æœä½ æœ‰ä»€ä¹ˆè¦è¯´çš„ï¼Œå°±åƒå®ƒæ˜¯çƒ­çš„ä¸€æ ·ä¸‹é™ [@RicBrazao](https://twitter.com/RicBrazao) ï¼

[![](img/50ef4044ecd4e250b5d50f368b775d38.png)](http://bit.ly/HackernoonFB)[![](img/979d9a46439d5aebbdcdca574e21dc81.png)](https://goo.gl/k7XYbx)[![](img/2930ba6bd2c12218fdbbf7e02c8746ff.png)](https://goo.gl/4ofytp)

> [é»‘å®¢ä¸­åˆ](http://bit.ly/Hackernoon)æ˜¯é»‘å®¢å¦‚ä½•å¼€å§‹ä»–ä»¬çš„ä¸‹åˆã€‚æˆ‘ä»¬æ˜¯è¿™ä¸ªå®¶åº­çš„ä¸€å‘˜ã€‚æˆ‘ä»¬ç°åœ¨[æ¥å—æŠ•ç¨¿](http://bit.ly/hackernoonsubmission)å¹¶ä¹æ„[è®¨è®ºå¹¿å‘Š&èµåŠ©](mailto:partners@amipublications.com)æœºä¼šã€‚
> 
> å¦‚æœä½ å–œæ¬¢è¿™ä¸ªæ•…äº‹ï¼Œæˆ‘ä»¬æ¨èä½ é˜…è¯»æˆ‘ä»¬çš„[æœ€æ–°ç§‘æŠ€æ•…äº‹](http://bit.ly/hackernoonlatestt)å’Œ[è¶‹åŠ¿ç§‘æŠ€æ•…äº‹](https://hackernoon.com/trending)ã€‚ç›´åˆ°ä¸‹ä¸€æ¬¡ï¼Œä¸è¦æŠŠä¸–ç•Œçš„ç°å®æƒ³å½“ç„¶ï¼

![](img/be0ca55ba73a573dce11effb2ee80d56.png)